!function(){L.Control.LinearMeasurement=L.Control.extend({options:{position:"topleft",unitSystem:"imperial",color:"#4D90FE",contrastingColor:"#fff"},onAdd:function(t){function i(t){return s(t)>=165?"000":"fff"}function s(t){var i="string"==typeof t?o(t):t;return.2126*i[0]+.7152*i[1]+.0722*i[2]}function o(t){if(3===t.length)t=t.charAt(0)+t.charAt(0)+t.charAt(1)+t.charAt(1)+t.charAt(2)+t.charAt(2);else if(6!==t.length)throw"Invalid hex color: "+t;for(var i=[],s=0;s<=2;s++)i[s]=parseInt(t.substr(2*s,2),16);return i}var e=L.DomUtil.create("div","leaflet-control leaflet-bar"),a=L.DomUtil.create("a","icon-ruler",e),l=t.getContainer(),n=this;a.href="#",a.title="Toggle measurement tool",L.DomEvent.on(a,"click",L.DomEvent.stop).on(a,"click",function(){L.DomUtil.hasClass(a,"icon-active")?(n.resetRuler(!!n.mainLayer),L.DomUtil.removeClass(a,"icon-active"),L.DomUtil.removeClass(l,"ruler-map")):(n.initRuler(),L.DomUtil.addClass(a,"icon-active"),L.DomUtil.addClass(l,"ruler-map"))}),this.options.color&&this.options.color.indexOf("#")===-1?this.options.color="#"+this.options.color:this.options.color||(this.options.color="#4D90FE");var r=this.options.color.replace("#","");return this.options.contrastingColor="#"+i(r),e},onRemove:function(t){this.resetRuler(!!this.mainLayer)},initRuler:function(){var t=this._map;this.mainLayer=L.featureGroup(),this.mainLayer.addTo(this._map),t.touchZoom.disable(),t.doubleClickZoom.disable(),t.boxZoom.disable(),t.keyboard.disable(),t.tap&&t.tap.disable(),this.dblClickEventFn=function(t){L.DomEvent.stop(t)},t.on("click",this.getMouseClickHandler,this),t.on("mousemove",this.getMouseMoveHandler,this),t.on("dblclick",this.dblClickEventFn,t),this.resetRuler()},initLayer:function(){this.layer=L.featureGroup(),this.layer.addTo(this.mainLayer),this.layer.on("selected",this.layerSelected),this.layer.on("click",this.getMouseClickHandler,this),this.layer.on("dblclick",this.getDblClickHandler,this)},resetRuler:function(t){var i=this._map;t&&(i.off("click",this.clickEventFn,this),i.off("mousemove",this.moveEventFn,this),i.off("dblclick",this.dblClickEventFn,i),this.mainLayer&&this._map.removeLayer(this.mainLayer),this.mainLayer=null,this._map.touchZoom.enable(),this._map.boxZoom.enable(),this._map.keyboard.enable(),this._map.tap&&this._map.tap.enable()),this.layer=null,this.prevLatlng=null,this.poly=null,this.multi=null,this.latlngs=null,this.latlngsList=[],this.sum=0,this.distance=0,this.separation=1,this.last=0,this.fixedLast=0,this.totalIcon=null,this.total=null,this.lastCircle=null,this.UNIT_CONV=1e3,this.SUB_UNIT_CONV=1e3,this.UNIT="km",this.SUB_UNIT="m","imperial"===this.options.unitSystem&&(this.UNIT_CONV=1609.344,this.SUB_UNIT_CONV=5280,this.UNIT="mi",this.SUB_UNIT="ft"),this.measure={scalar:0,unit:this.SUB_UNIT}},cleanUpMarkers:function(t){var i=this.layer;i&&i.eachLayer(function(s){s.options&&"tmp"===s.options.type&&(t?s.options.type="fixed":i.removeLayer(s))})},cleanUpFixed:function(){var t=this.layer;t&&t.eachLayer(function(i){i.options&&"fixed"===i.options.type&&t.removeLayer(i)})},convertDots:function(){var t=this,i=this.layer;i&&i.eachLayer(function(i){if(i.options&&"dot"===i.options.type){var s=i.options.marker,o=s?s.options.icon.options:null,e=o?o.html:"";if(e&&e.indexOf(t.measure.unit)===-1){var a=i.options.label,l=a.split(" "),n=parseFloat(l[0]),r=l[1],h="";i.options.label.indexOf(t.measure.unit)!==-1?h=i.options.label:r===t.UNIT?h=(n*t.SUB_UNIT_CONV).toFixed(2)+" "+t.SUB_UNIT:r===t.SUB_UNIT&&(h=(n/t.SUB_UNIT_CONV).toFixed(2)+" "+t.UNIT);var c=L.divIcon({className:"total-popup-label",html:h});s.setIcon(c)}}})},displayMarkers:function(t,i,s){var o,e,a,l,n,r=t[t.length-1],h=t[0],c=h.distanceTo(r)/this.UNIT_CONV,p=c,u=this._map.latLngToContainerPoint(r),m=this._map.latLngToContainerPoint(h),d=1;this.measure.unit===this.SUB_UNIT&&(d=this.SUB_UNIT_CONV,p*=d);for(var y=s*d+p,f=s*d,v=Math.floor(f);v<y;v++)l=(y-v)/p,v%this.separation||v<f||(o=u.x-l*(u.x-m.x),e=u.y-l*(u.y-m.y),n=L.point(o,e),r=this._map.containerPointToLatLng(n),a=v+" "+this.measure.unit,this.renderCircle(r,0,this.layer,i?"fixed":"tmp",a),this.last=y);return c},renderCircle:function(t,i,s,o,e){var a=this.options.color,l=this.options.color;o=o||"circle",linesHTML=[];var n={color:l,fillOpacity:1,opacity:1,fill:!0,type:o},r=this._map.latLngToContainerPoint(t);if(p_latLng=this._map.containerPointToLatLng(r),e){var h=L.divIcon({className:"total-popup-label",html:'<span style="color: '+a+';">'+e+"</span>"});n.icon=h,n.marker=L.marker(p_latLng,{icon:h,type:o}).addTo(s),n.label=e}var c=L.circleMarker(t,n);return c.setRadius(3),c.addTo(s),c},renderPolyline:function(t,i,s){var o=L.polyline(t,{color:this.options.color,weight:2,opacity:1,dashArray:i});return o.addTo(s),o},renderMultiPolyline:function(t,i,s){var o;return o=L.version.startsWith("0")?L.multiPolyline(t,{color:this.options.color,weight:2,opacity:1,dashArray:i}):L.polyline(t,{color:this.options.color,weight:2,opacity:1,dashArray:i}),o.addTo(s),o},formatDistance:function(t,i){var s=L.Util.formatNum(t<1?t*parseFloat(this.SUB_UNIT_CONV):t,i),o=t<1?this.SUB_UNIT:this.UNIT;return{scalar:s,unit:o}},hasClass:function(t,i){var s=L.DomUtil.hasClass;for(var o in i)if(s(t,i[o]))return!0;return!1},getMouseClickHandler:function(t){var i=this,s=t.originalEvent.target;if(!this.hasClass(s,["leaflet-popup","total-popup-content"])){i.layer||i.initLayer(),i.cleanUpMarkers(!0),i.fixedLast=i.last,i.prevLatlng=t.latlng,i.sum=0,i.poly&&(i.latlngsList.push(i.latlngs),i.multi?i.multi.setLatLngs(i.latlngsList):i.multi=i.renderMultiPolyline(i.latlngsList,"5 5",i.layer,"dot"));var o,e;for(var a in i.latlngsList)o=i.latlngsList[a],i.sum+=o[0].distanceTo(o[1])/i.UNIT_CONV;e=i.measure.unit===this.SUB_UNIT?i.sum*i.SUB_UNIT_CONV:i.sum;var l=e.toFixed(2);i.renderCircle(t.latlng,0,i.layer,"dot",parseInt(l)?l+" "+i.measure.unit:"")}},getMouseMoveHandler:function(t){if(this.prevLatlng){this.latlngs=[this.prevLatlng,t.latlng],this.poly?this.poly.setLatLngs(this.latlngs):this.poly=this.renderPolyline(this.latlngs,"5 5",this.layer),this.distance=parseFloat(this.prevLatlng.distanceTo(t.latlng))/this.UNIT_CONV,this.measure=this.formatDistance(this.distance+this.sum,2);var i=this.measure.scalar+" "+this.measure.unit,s='<span class="total-popup-content" style="background-color:'+this.options.color+"; color: "+this.options.contrastingColor+'">'+i+"</span>";this.total?(this.totalIcon=L.divIcon({className:"total-popup",html:s}),this.total.setLatLng(t.latlng),this.total.setIcon(this.totalIcon)):(this.totalIcon=L.divIcon({className:"total-popup",html:s}),this.total=L.marker(t.latlng,{icon:this.totalIcon,clickable:!0}).addTo(this.layer));var o=this.measure.scalar,e=this.separation,a=parseInt(o).toString().length,l=Math.pow(10,a),n=o>l/2?l/10:l/20,r=0;if(this.separation=n,e!==this.separation&&this.fixedLast){this.cleanUpMarkers(),this.cleanUpFixed();var h=this.multi.getLatLngs();for(var c in h)r+=this.displayMarkers.apply(this,[h[c],!0,r]);this.displayMarkers.apply(this,[this.poly.getLatLngs(),!1,this.sum]),this.convertDots()}else this.cleanUpMarkers(),this.displayMarkers.apply(this,[this.poly.getLatLngs(),!1,this.sum])}},getDblClickHandler:function(t){var i=this;if(this.total){this.cleanUpLastNodes(),this.layer.off("click"),this.layer.off("dblclick"),L.DomEvent.stop(t);var s=this.layer,o=this.measure.scalar+" "+this.measure.unit+" ",e=(this.measure.unit===this.SUB_UNIT?this.measure.scalar/this.UNIT_CONV:this.measure.scalar,this.total.getLatLng(),this.total),a=['<div class="total-popup-content" style="background-color:'+this.options.color+"; color: "+this.options.contrastingColor+'">'+o,'  <svg class="close" viewbox="0 0 45 35">','   <path style="stroke: '+this.options.contrastingColor+'" class="close" d="M 10,10 L 30,30 M 30,10 L 10,30" />',"  </svg>","</div>"].join("");this.totalIcon=L.divIcon({className:"total-popup",html:a}),this.total.setIcon(this.totalIcon);var l={total:this.measure,total_label:e,unit:this.UNIT_CONV,sub_unit:this.SUB_UNIT_CONV},n=function(t){L.DomUtil.hasClass(t.originalEvent.target,"close")?i.mainLayer.removeLayer(s):s.fireEvent("selected",l)};s.on("click",n),s.fireEvent("selected",l),this.resetRuler(!1)}},cleanUpLastNodes:function(){var t=[];this.layer.eachLayer(function(i,s){"dot"===i.options.type&&t.push(i)}),this.purgeLayers(t.splice(-4))},purgeLayers:function(t){for(var i in t)t[i]&&this.layer.removeLayer(t[i])},layerSelected:function(t){}})}();